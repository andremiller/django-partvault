{% extends "partvault/base.html" %}
{% load django_bootstrap5 %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-sm-10 col-md-8 col-lg-6">
        <div class="card shadow-sm pv-form-card">
            <div class="card-body">
                <h1 class="h4 mb-1 pv-page-title">{% if is_edit %}Edit item{% else %}New item{% endif %}</h1>
                <p class="pv-subtle mb-3">Use structured fields to keep your catalog searchable and consistent.</p>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <section class="pv-form-section mb-3">
                        <h2 class="h6 pv-form-section-title">Core details</h2>
                        {% bootstrap_field form.collection %}
                        {% bootstrap_field form.name %}
                        <div class="row g-3">
                            <div class="col-md-8">
                                {% bootstrap_field form.category %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Custom category</label>
                                {{ category_formset.management_form }}
                                {% for related_form in category_formset %}
                                    {% bootstrap_field related_form.name show_label=False placeholder="Category name" %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-8">
                                {% bootstrap_field form.manufacturer %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Custom manufacturer</label>
                                {{ manufacturer_formset.management_form }}
                                {% for related_form in manufacturer_formset %}
                                    {% bootstrap_field related_form.name show_label=False placeholder="Manufacturer name" %}
                                {% endfor %}
                            </div>
                        </div>
                        {% bootstrap_field form.model %}
                        {% bootstrap_field form.revision %}
                        {% bootstrap_field form.serial %}
                        {% bootstrap_field form.release_date %}
                        <div class="row g-3">
                            <div class="col-md-8">
                                {% bootstrap_field form.status %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Custom status</label>
                                {{ status_formset.management_form }}
                                {% for related_form in status_formset %}
                                    {% bootstrap_field related_form.name show_label=False placeholder="Status name" %}
                                    {% bootstrap_field related_form.color show_label=False %}
                                {% endfor %}
                            </div>
                        </div>
                    </section>

                    <section class="pv-form-section mb-3">
                        <h2 class="h6 pv-form-section-title">Placement and tags</h2>
                        {% bootstrap_field form.location %}
                        {% bootstrap_field form.parent_item %}
                        <div class="row g-3">
                            <div class="col-md-8">
                                {% bootstrap_field form.tags %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Custom tags</label>
                                {{ tag_formset.management_form }}
                                {% for related_form in tag_formset %}
                                    {% bootstrap_field related_form.name show_label=False placeholder="Tag name" %}
                                {% endfor %}
                            </div>
                        </div>
                    </section>

                    <section class="pv-form-section mb-3">
                        <h2 class="h6 pv-form-section-title">Photos</h2>
                        {{ photo_formset.non_form_errors }}
                        {{ photo_formset.management_form }}
                        {% for related_form in photo_formset %}
                            {{ related_form.id }}
                            <div class="row g-2 align-items-end mb-2 pv-inline-form-row">
                                <div class="col-md-8">
                                    {% bootstrap_field related_form.image show_label=False %}
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_field related_form.is_thumbnail show_help=False %}
                                </div>
                                <div class="col-md-1">
                                    {% if related_form.instance.pk %}
                                        <label class="form-label d-block">Del?</label>
                                        {% bootstrap_field related_form.DELETE show_label=False %}
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </section>

                    <section class="pv-form-section mb-3">
                        <h2 class="h6 pv-form-section-title">Documents</h2>
                        {{ document_formset.non_form_errors }}
                        {{ document_formset.management_form }}
                        {% for related_form in document_formset %}
                            {{ related_form.id }}
                            <div class="row g-2 align-items-end mb-2 pv-inline-form-row">
                                <div class="col-md-3">
                                    {% bootstrap_field related_form.document_type show_label=False %}
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_field related_form.new_document_type show_label=False placeholder="Custom type" %}
                                </div>
                                <div class="col-md-5">
                                    {% bootstrap_field related_form.file show_label=False %}
                                </div>
                                <div class="col-md-1">
                                    {% if related_form.instance.pk %}
                                        <label class="form-label d-block">Del?</label>
                                        {% bootstrap_field related_form.DELETE show_label=False %}
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </section>

                    <section class="pv-form-section mb-3">
                        <h2 class="h6 pv-form-section-title">Links</h2>
                        {{ link_formset.non_form_errors }}
                        {{ link_formset.management_form }}
                        {% for related_form in link_formset %}
                            {{ related_form.id }}
                            <div class="row g-2 align-items-end mb-2 pv-inline-form-row">
                                <div class="col-md-3">
                                    {% bootstrap_field related_form.link_type show_label=False %}
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_field related_form.new_link_type show_label=False placeholder="Custom type" %}
                                </div>
                                <div class="col-md-5">
                                    {% bootstrap_field related_form.url show_label=False %}
                                </div>
                                <div class="col-md-1">
                                    {% if related_form.instance.pk %}
                                        <label class="form-label d-block">Del?</label>
                                        {% bootstrap_field related_form.DELETE show_label=False %}
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </section>

                    <section class="pv-form-section mb-4">
                        <h2 class="h6 pv-form-section-title">Notes and timeline</h2>
                        {% bootstrap_field form.notes %}
                        <div class="row g-3">
                            <div class="col-md-6">
                                {% bootstrap_field form.acquired_on %}
                            </div>
                            <div class="col-md-6">
                                {% bootstrap_field form.last_tested_on %}
                            </div>
                        </div>
                    </section>

                    <div class="d-flex gap-2 flex-wrap pv-form-actions">
                        <button class="btn btn-primary" type="submit">
                            {% if is_edit %}Save changes{% else %}Create item{% endif %}
                        </button>
                        {% if is_edit %}
                            <a class="btn btn-outline-secondary" href="{% url 'item' item.id %}">Cancel</a>
                        {% else %}
                            {% if request.user.profile.active_collection_id %}
                                <a class="btn btn-outline-secondary" href="{% url 'items' request.user.profile.active_collection_id %}">Cancel</a>
                            {% else %}
                                <a class="btn btn-outline-secondary" href="{% url 'collections' %}">Cancel</a>
                            {% endif %}
                        {% endif %}
                    </div>
                </form>
                {% if is_edit %}
                    <form
                        class="mt-3"
                        method="post"
                        action="{% url 'item_delete' item.id %}"
                        onsubmit="return confirm('Delete this item? This cannot be undone.');"
                    >
                        {% csrf_token %}
                        <button class="btn btn-outline-danger" type="submit">Delete item</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="cropper-modal" id="photoCropModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="cropper-modal__backdrop" data-cropper-close></div>
    <div class="cropper-modal__dialog" role="document">
        <div class="cropper-modal__header">
            <h2 class="h5 mb-0">Crop photo</h2>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-cropper-close>Cancel</button>
        </div>
        <div class="cropper-modal__body">
            <p class="text-muted d-none" id="photoCropperLoading">Loading cropperâ€¦</p>
            <p class="text-danger d-none" id="photoCropperError">Cropping failed to start. Please try again.</p>
            <div class="cropper-container" id="photoCropperContainer"></div>
        </div>
        <div class="cropper-modal__footer">
            <button class="btn btn-primary" type="button" id="photoCropConfirm">Use crop</button>
            <button class="btn btn-outline-secondary" type="button" data-cropper-close>Cancel</button>
        </div>
    </div>
</div>

<style>
    .cropper-modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 1050;
        align-items: center;
        justify-content: center;
    }

    .cropper-modal.is-open {
        display: flex;
    }

    .cropper-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
    }

    .cropper-modal__dialog {
        position: relative;
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
        width: min(960px, 92vw);
        max-height: 92vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .cropper-modal__header,
    .cropper-modal__footer {
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .cropper-modal__footer {
        border-bottom: none;
        border-top: 1px solid #e5e7eb;
        justify-content: flex-end;
    }

    .cropper-modal__body {
        padding: 1rem;
        overflow: auto;
        background: #fff;
    }

    .cropper-container {
        min-height: 320px;
    }

    .cropper-container cropper-canvas {
        height: min(65vh, 520px);
        width: 100%;
    }

    body.cropper-modal-open {
        overflow: hidden;
    }

    @media (max-width: 768px) {
        .cropper-modal {
            align-items: stretch;
            justify-content: stretch;
        }

        .cropper-modal__dialog {
            width: 100%;
            height: 100%;
            max-height: 100%;
            border-radius: 0;
        }

        .cropper-container cropper-canvas {
            height: 60vh;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/cropperjs@2.1.0/dist/cropper.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("photoCropModal");
        if (!modal) {
            return;
        }
        const modalCloseButtons = modal.querySelectorAll("[data-cropper-close]");
        const confirmButton = document.getElementById("photoCropConfirm");
        const container = document.getElementById("photoCropperContainer");
        const loadingMessage = document.getElementById("photoCropperLoading");
        const errorMessage = document.getElementById("photoCropperError");
        if (!confirmButton || !container || !loadingMessage || !errorMessage) {
            return;
        }
        const fileInputs = document.querySelectorAll(
            "input[type=\"file\"][name^=\"photo-\"][name$=\"-image\"]"
        );

        let activeInput = null;
        let activeFile = null;
        let activeObjectUrl = null;
        let activeSelection = null;
        let activeNaturalWidth = null;
        let activeNaturalHeight = null;

        const cleanupCropper = () => {
            activeSelection = null;
            activeNaturalWidth = null;
            activeNaturalHeight = null;
            if (activeObjectUrl) {
                URL.revokeObjectURL(activeObjectUrl);
                activeObjectUrl = null;
            }
            container.innerHTML = "";
            loadingMessage.classList.add("d-none");
            errorMessage.classList.add("d-none");
            activeFile = null;
        };

        const closeModal = ({ clearInput } = { clearInput: false }) => {
            modal.classList.remove("is-open");
            modal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("cropper-modal-open");
            if (clearInput && activeInput) {
                activeInput.value = "";
            }
            cleanupCropper();
            activeInput = null;
        };

        const openModal = () => {
            modal.classList.add("is-open");
            modal.setAttribute("aria-hidden", "false");
            document.body.classList.add("cropper-modal-open");
        };

        const isCropperDefined = () => {
            return !!window.customElements.get("cropper-canvas");
        };

        const buildCropperTemplate = () => {
            if (window.Cropper && window.Cropper.DEFAULT_TEMPLATE) {
                container.innerHTML = window.Cropper.DEFAULT_TEMPLATE;
                return;
            }
            const canvas = document.createElement("cropper-canvas");
            canvas.setAttribute("background", "");
            const image = document.createElement("cropper-image");
            const shade = document.createElement("cropper-shade");
            shade.setAttribute("hidden", "");
            const selectHandle = document.createElement("cropper-handle");
            selectHandle.setAttribute("action", "select");
            selectHandle.setAttribute("plain", "");
            const selection = document.createElement("cropper-selection");
            selection.setAttribute("initial-coverage", "0.5");
            selection.setAttribute("movable", "");
            selection.setAttribute("resizable", "");
            const grid = document.createElement("cropper-grid");
            grid.setAttribute("role", "grid");
            grid.setAttribute("bordered", "");
            grid.setAttribute("covered", "");
            const crosshair = document.createElement("cropper-crosshair");
            crosshair.setAttribute("centered", "");
            const moveHandle = document.createElement("cropper-handle");
            moveHandle.setAttribute("action", "move");
            moveHandle.setAttribute("theme-color", "rgba(255, 255, 255, 0.35)");
            selection.appendChild(grid);
            selection.appendChild(crosshair);
            selection.appendChild(moveHandle);
            ["n", "e", "s", "w", "ne", "nw", "se", "sw"].forEach((direction) => {
                const handle = document.createElement("cropper-handle");
                handle.setAttribute("action", `${direction}-resize`);
                selection.appendChild(handle);
            });
            canvas.appendChild(image);
            canvas.appendChild(shade);
            canvas.appendChild(selectHandle);
            canvas.appendChild(selection);
            container.appendChild(canvas);
        };

        const openCropperForFile = (input, file) => {
            openModal();
            loadingMessage.classList.remove("d-none");
            if (!isCropperDefined()) {
                errorMessage.classList.remove("d-none");
                loadingMessage.classList.add("d-none");
                input.value = "";
                return;
            }
            cleanupCropper();
            activeInput = input;
            activeFile = file;
            activeObjectUrl = URL.createObjectURL(file);
            buildCropperTemplate();
            const cropperImage = container.querySelector("cropper-image");
            const cropperSelection = container.querySelector("cropper-selection");
            if (!cropperImage || !cropperSelection) {
                errorMessage.classList.remove("d-none");
                loadingMessage.classList.add("d-none");
                if (activeInput) {
                    activeInput.value = "";
                }
                return;
            }
            cropperImage.setAttribute("src", activeObjectUrl);
            cropperImage.setAttribute("alt", "Photo to crop");
            activeSelection = cropperSelection;
            cropperImage
                .$ready()
                .then((image) => {
                    if (image) {
                        activeNaturalWidth = image.naturalWidth;
                        activeNaturalHeight = image.naturalHeight;
                    }
                    const cropperCanvas = container.querySelector("cropper-canvas");
                    if (cropperCanvas && typeof activeSelection.$change === "function") {
                        const canvasRect = cropperCanvas.getBoundingClientRect();
                        const imageRect = cropperImage.getBoundingClientRect();
                        activeSelection.$change(
                            imageRect.left - canvasRect.left,
                            imageRect.top - canvasRect.top,
                            imageRect.width,
                            imageRect.height
                        );
                    }
                    loadingMessage.classList.add("d-none");
                })
                .catch(() => {
                    errorMessage.classList.remove("d-none");
                    loadingMessage.classList.add("d-none");
                    if (activeInput) {
                        activeInput.value = "";
                    }
                });
        };

        const replaceInputWithBlob = (blob) => {
            if (!activeInput) {
                return;
            }
            const originalName = activeFile ? activeFile.name : "cropped-image.png";
            const croppedFile = new File([blob], originalName, {
                type: blob.type || "image/png",
                lastModified: Date.now(),
            });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);
            activeInput.files = dataTransfer.files;
        };

        const getOutputSize = () => {
            if (!activeSelection || !activeNaturalWidth || !activeNaturalHeight) {
                return null;
            }
            const selectionRect = activeSelection.getBoundingClientRect();
            const imageRect = container.querySelector("cropper-image")?.getBoundingClientRect();
            if (!imageRect || !imageRect.width || !imageRect.height) {
                return null;
            }
            const scaleX = activeNaturalWidth / imageRect.width;
            const scaleY = activeNaturalHeight / imageRect.height;
            const width = Math.round(selectionRect.width * scaleX);
            const height = Math.round(selectionRect.height * scaleY);
            if (!width || !height) {
                return null;
            }
            return { width, height };
        };

        modalCloseButtons.forEach((button) => {
            button.addEventListener("click", () => {
                closeModal({ clearInput: true });
            });
        });

        confirmButton.addEventListener("click", () => {
            if (!activeSelection || !activeFile) {
                closeModal({ clearInput: true });
                return;
            }
            if (typeof activeSelection.$toCanvas !== "function") {
                closeModal({ clearInput: true });
                return;
            }
            const outputType = activeFile.type && activeFile.type.startsWith("image/")
                ? activeFile.type
                : "image/png";
            activeSelection
                .$toCanvas(getOutputSize() || undefined)
                .then((canvas) => {
                    canvas.toBlob((blob) => {
                        if (!blob) {
                            closeModal({ clearInput: true });
                            return;
                        }
                        replaceInputWithBlob(blob);
                        closeModal({ clearInput: false });
                    }, outputType);
                })
                .catch(() => {
                    closeModal({ clearInput: true });
                });
        });

        fileInputs.forEach((input) => {
            input.addEventListener("change", (event) => {
                const file = event.target.files && event.target.files[0];
                if (!file) {
                    return;
                }
                openCropperForFile(input, file);
            });
        });
    });
</script>
{% endblock %}
