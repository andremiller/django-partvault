{% extends "partvault/base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between gap-3 flex-wrap mb-3">
    <div class="d-flex align-items-center gap-3">
        {% if is_all_items_view %}
            <div>
                <h1 class="h3 mb-0">
                    <a class="text-decoration-none" href="{% url 'items_all' %}">All Items</a>
                </h1>
                {% if selected_collection %}
                    <p class="small text-muted mb-0">
                        Filtered to {{ selected_collection.owner_code }} - {{ selected_collection.name }}
                    </p>
                {% endif %}
            </div>
        {% else %}
            <h1 class="h3 mb-0">
                <a class="text-decoration-none" href="{% url 'items' collection.id %}">
                    {{ collection.owner_code }} - {{ collection.name }} Items
                </a>
            </h1>
        {% endif %}
        <span class="badge bg-secondary">{{ total_item_count }}</span>
    </div>
    <div class="d-flex align-items-center gap-2">
        {% if not is_all_items_view and request.user.is_authenticated and request.user == collection.owner %}
            <a class="btn btn-sm btn-outline-primary" href="{% url 'collection_edit' collection.id %}">Edit collection</a>
        {% endif %}
        {% if request.user.is_authenticated %}
            <a class="btn btn-sm btn-primary" href="{% url 'item_create' %}">New item</a>
        {% endif %}
    </div>
</div>
<form method="get" action="{{ items_url }}" class="row g-2 align-items-end mb-3">
    {% if is_all_items_view %}
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label mb-1" for="collection-filter">Collection</label>
            <select class="form-select" id="collection-filter" name="collection">
                <option value="">All collections</option>
                {% for filter_collection in available_collections %}
                    <option
                        value="{{ filter_collection.id }}"
                        {% if selected_collection and selected_collection.id == filter_collection.id %}selected{% endif %}
                    >
                        {{ filter_collection.owner_code }} - {{ filter_collection.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}
    <div class="col-12 col-md-6 col-lg-3">
        <label class="form-label mb-1" for="category-filter">Category</label>
        <select class="form-select" id="category-filter" name="category">
            <option value="">All categories</option>
            {% for filter_category in available_categories %}
                <option
                    value="{{ filter_category.id }}"
                    {% if selected_category_id == filter_category.id %}selected{% endif %}
                >
                    {{ filter_category.name }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <label class="form-label mb-1" for="manufacturer-filter">Manufacturer</label>
        <select class="form-select" id="manufacturer-filter" name="manufacturer">
            <option value="">All manufacturers</option>
            {% for filter_manufacturer in available_manufacturers %}
                <option
                    value="{{ filter_manufacturer.id }}"
                    {% if selected_manufacturer_id == filter_manufacturer.id %}selected{% endif %}
                >
                    {{ filter_manufacturer.name }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <label class="form-label mb-1" for="search-filter">Search</label>
        <input
            class="form-control"
            id="search-filter"
            name="q"
            type="search"
            value="{{ search_term }}"
            placeholder="Name, model, serial, tag, notes..."
        />
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-outline-primary">Apply filters</button>
    </div>
    {% if has_active_filters %}
        <div class="col-auto">
            <a class="btn btn-link" href="{{ items_url }}">Clear</a>
        </div>
    {% endif %}
</form>
<div class="table-responsive pv-table-wrap">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th scope="col">Photo</th>
                <th scope="col">Asset tag</th>
                <th scope="col">Name</th>
                <th scope="col">Category</th>
                <th scope="col">Manufacturer</th>
                <th scope="col">Model</th>
                <th scope="col">Date</th>
                <th scope="col">Tags</th>
                <th scope="col">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for item in item_list %}
                <tr class="pv-clickable-row" data-href="{% url 'item' item.id %}">
                    <td data-label="Photo" class="pv-cell-photo">
                        {% with photo=item.ordered_photos.0 %}
                            {% if photo %}
                                <a href="{% url 'item' item.id %}" class="d-inline-block">
                                    <img
                                        src="{% url 'photo_image_scaled' photo.id 120 %}"
                                        alt="Thumbnail for {{ item.name }}"
                                        class="pv-thumb border"
                                    />
                                </a>
                            {% else %}
                                <div
                                    class="bg-light border rounded d-flex align-items-center justify-content-center text-muted"
                                    style="width: 56px; height: 56px;"
                                >
                                    â€”
                                </div>
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td data-label="Asset tag">
                        <span class="pv-mobile-asset-media" aria-hidden="true">
                            {% with photo=item.ordered_photos.0 %}
                                {% if photo %}
                                    <img
                                        src="{% url 'photo_image_scaled' photo.id 120 %}"
                                        alt=""
                                        class="pv-thumb border"
                                    />
                                {% else %}
                                    <span
                                        class="bg-light border rounded d-flex align-items-center justify-content-center text-muted"
                                        style="width: 56px; height: 56px;"
                                    >
                                        -
                                    </span>
                                {% endif %}
                            {% endwith %}
                        </span>
                        <a class="text-decoration-none" href="{% url 'item' item.id %}">
                            {{ item.asset_tag|default:"-" }}
                        </a>
                        <div class="small text-muted">
                            <span class="pv-code">{{ item.collection.owner_code|default:"-" }}-{{ item.collection.collection_code|default:"-" }}</span>
                        </div>
                    </td>
                    <td data-label="Name">{{ item.name }}</td>
                    <td data-label="Category">
                        {% if item.category %}
                            <a
                                class="text-decoration-none"
                                href="{{ items_url }}?{{ filter_query_prefix }}category={{ item.category.id }}"
                            >
                                {{ item.category }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-label="Manufacturer">
                        {% if item.manufacturer %}
                            <a
                                class="text-decoration-none"
                                href="{{ items_url }}?{{ filter_query_prefix }}manufacturer={{ item.manufacturer.id }}"
                            >
                                {{ item.manufacturer }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-label="Model">{{ item.model|default:"-" }}</td>
                    <td data-label="Date">
                        {% if item.release_date and item.manufacture_date %}
                            {% if item.release_date <= item.manufacture_date %}
                                {{ item.release_date|date:"Y-m" }}
                            {% else %}
                                {{ item.manufacture_date|date:"Y-m" }}
                            {% endif %}
                        {% elif item.release_date %}
                            {{ item.release_date|date:"Y-m" }}
                        {% elif item.manufacture_date %}
                            {{ item.manufacture_date|date:"Y-m" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-label="Tags">
                        {% for tag in item.tags.all %}
                            <a
                                class="text-decoration-none"
                                href="{{ items_url }}?{{ filter_query_prefix }}tag={{ tag.id }}"
                            >
                                <span class="badge pv-tag me-1">{{ tag }}</span>
                            </a>
                        {% empty %}
                            <span class="text-muted">-</span>
                        {% endfor %}
                    </td>
                    <td data-label="Status">
                        {% if item.status %}
                            {% with status_color=item.status.color %}
                                <span class="badge {{ status_color }}{% if status_color == "bg-light" or status_color == "bg-warning" or status_color == "bg-info" %} text-dark{% else %} text-light{% endif %}">
                                    {{ item.status }}
                                </span>
                            {% endwith %}
                        {% else %}
                            <span class="badge bg-info text-dark">-</span>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="9" class="text-muted pv-table-empty">No items found.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if page_obj.paginator.num_pages > 1 %}
    <nav aria-label="Items pagination" class="mt-3">
        <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a
                        class="page-link"
                        href="{{ items_url }}?{% if pagination_query %}{{ pagination_query }}&{% endif %}page=1"
                    >
                        First
                    </a>
                </li>
                <li class="page-item">
                    <a
                        class="page-link"
                        href="{{ items_url }}?{% if pagination_query %}{{ pagination_query }}&{% endif %}page={{ page_obj.previous_page_number }}"
                    >
                        Previous
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">First</span></li>
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
            </li>
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a
                        class="page-link"
                        href="{{ items_url }}?{% if pagination_query %}{{ pagination_query }}&{% endif %}page={{ page_obj.next_page_number }}"
                    >
                        Next
                    </a>
                </li>
                <li class="page-item">
                    <a
                        class="page-link"
                        href="{{ items_url }}?{% if pagination_query %}{{ pagination_query }}&{% endif %}page={{ page_obj.paginator.num_pages }}"
                    >
                        Last
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
                <li class="page-item disabled"><span class="page-link">Last</span></li>
            {% endif %}
        </ul>
    </nav>
{% endif %}
{% endblock %}
